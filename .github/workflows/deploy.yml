name: Deploy Frontend

on:
    push:
        branches: ["main"]

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: wirabudhi/fe-parthamanunggal

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write

        steps:
            - uses: actions/checkout@v4

            - name: Login to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GHCR_PAT }}

            - name: Build & Push
              uses: docker/build-push-action@v5
              with:
                  context: .
                  push: true
                  tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
                  build-args: |
                      NEXT_PUBLIC_API_BASE_URL=https://api.partha-manunggal.com/api
                      NEXT_PUBLIC_API_URL=https://api.partha-manunggal.com/api
                      INTERNAL_API_BASE_URL=http://backend
                      NEXT_PUBLIC_USE_SERVER_AUTH=1
                      NEXT_PUBLIC_USE_SANCTUM=1
                      NEXT_PUBLIC_AUTO_LOGIN=1
                      NEXT_PUBLIC_AUTO_LOGIN_EMAIL=admin@example.com
                      NEXT_PUBLIC_AUTO_LOGIN_PASSWORD=password
                      NEXT_PUBLIC_JENIS_SUKARELA=1
                      NEXT_PUBLIC_JENIS_WAJIB_USAHA=2
                      NEXT_PUBLIC_JENIS_BERJANGKA=3
                      NEXT_PUBLIC_JENIS_POKOK=4
                      NEXT_PUBLIC_JENIS_WAJIB=5
                      NEXT_PUBLIC_JENIS_WAJIB_KHUSUS=6
                      NEXT_PUBLIC_JENIS_KHUSUS=7
                      NEXT_PUBLIC_JENIS_MODAL=8
                      NEXT_PUBLIC_JENIS_TABUNGAN_HARIAN=1
                      NEXT_PUBLIC_JENIS_TABUNGAN_BERJANGKA=2
                      NEXT_PUBLIC_JENIS_TABUNGAN_DEPOSITO=3
                      NEXT_PUBLIC_ENABLE_INTEREST_TRIGGER=1

            - name: Deploy to VPS
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USERNAME }}
                  key: ${{ secrets.SSH_KEY }}
                  script: |
                      cd /var/www/partha

                      # 1. Login ke Docker Registry
                      echo ${{ secrets.GHCR_PAT }} | sudo docker login ghcr.io -u ${{ github.actor }} --password-stdin

                      # 2. Tarik Image Frontend Terbaru
                      sudo docker-compose -f docker-compose.app.yml pull frontend

                      # 3. Matikan & Nyalakan Frontend (Pakai force-recreate biar bersih)
                      sudo docker-compose -f docker-compose.app.yml up -d --force-recreate --no-deps frontend

                      # 4. --- INI TAMBAHANNYA: Restart Reverse Proxy ---
                      # Ini memaksa Nginx mendeteksi IP baru dari frontend
                      echo "Restarting Reverse Proxy..."
                      sudo docker restart koperasi-reverse-proxy

                      # 5. Bersihkan image lama
                      sudo docker image prune -f
